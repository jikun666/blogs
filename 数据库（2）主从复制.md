https://www.jianshu.com/p/faf0127f1cb2

复制过程分 3 步：

1. 主节点开启 binlog 功能和 IO 线程，用于记录对数据库记录有改变对 sql 语句；
2. 从节点开启 IO 线程。并通过 IO 线程从主节点的 IO 线程拉取某个 position 之后的 binlog 内容，写入到本地的 relaylog，创建一个 master.info 文件，记录主节点的 ip、用户名、密码、binlog 路径、binlog position；
1. 从节点同时开启 sql 线程实时监控 relaylog 是否有更新，有更新的话就对从节点进行相应 sql 语句的重放（执行）；

所以说主要来看是通过 2 个日志（binlog、relaylog）和 3 个线程完成的主从复制。

由于每个从节点都分别记录了自己当前处理二进制日志中的位置，因此可以断开从服务器的连接，重新连接后恢复继续处理。

注意，binlog 的大小可以通过 max_binlog_size 参数配置。

主从不一致：在写请求相当多的情况下，可能会造成从节点和主节点数据不一致的情况，这是因为日志传输过程中的短暂延迟、或者写命令较多，系统速度不匹配造成的。


Q: 执行主从复制开始时，主节点内已经有数据怎么办？

A: 只能锁定主节点，只许读不许写或者直接停机，然后把主节点数据备份至从节点。推荐工具 mysqldump


# 架构

**双主模式**

Master-Master复制的两台服务器，既是master，又是另一台服务器的slave。这样，任何一方所做的变更，都会通过复制应用到另外一方的数据库中。


**主动被动模式的双主**

由master-master结构变化而来的，它避免了M-M的缺点。

不同点在于其中只有一个节点在提供读写服务，另外一个节点时刻准备着，当主节点一旦故障马上接替服务。


面试的时候不要提上面两种，就说双主模式即可。



# 复制方式（面试高频）

1. 异步复制

    默认的复制方式，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理。
    
    这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从库上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。

2. 全同步复制

    指当主库执行完一个事务，**所有**的从库都执行了该事务才返回给客户端。
    
    因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。

3. 半同步复制

    主库只需要等待一个从库节点收到并且 Flush Binlog 到 Relay Log 文件即可，主库不需要等待所有从库给主库反馈。


总之，mysql主从模式默认是异步复制的，而MySQL Cluster是同步复制的，只要设置为相应的模式即是在使用相应的同步策略。

从MySQL5.5开始，MySQL以插件的形式支持半同步复制。其实说明半同步复制是更好的方式，兼顾了同步和性能的问题。