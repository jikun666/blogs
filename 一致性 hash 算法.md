如果原来是 3 台缓存节点，现在想扩容成 4 台怎么办，或者宕机了一台怎么办？

一致性 hash 算法用于解决动态 cahe 节点数问题。


（原来面试官问的是一致性hash算法，我还一直以为是怎么平滑扩容）


关键点：

**环形映射**

一个环形链表，共 2^32 个节点，每台缓存节点占据其中一个，每个 key hash 之后顺时针遇到的第一个缓存节点就是目标节点。

**缓存节点改变**

不管是缓存节点宕机还是增加，最多都只会让原先的一个缓存节点中的数据失效。


**数据倾斜/虚拟节点**


如果缓存节点hash之后在环上不均衡（通常缓存节点数少的时候出现），则缓存的节点数据就会不均衡，这种现象称为数据倾斜。通过加入虚拟节点的方法解决。

对每一个服务节点计算多个哈希，每个计算结果位置都放置一个此服务节点，称为虚拟节点。

具体做法可以先确定每个物理节点关联的虚拟节点数量，然后在ip或者主机名后面增加编号。

同时数据定位算法不变，只是多了一步虚拟节点到实际节点的映射，例如定位到“Node A#1”、“Node A#2”、“Node A#3”三个虚拟节点的数据均定位到Node A上。

每个物理节点关联的虚拟节点数量就根据具体的生产环境情况在确定。