
如何实现线上服务的分库分表？（如何实现线上服务的rehash？）

https://www.w3cschool.cn/architectroad/architectroad-level-split-database.html


分为垂直切分、水平切分。

**垂直切分**

将不同的属性拆分到不同到表中。

将长度较短、访问频率较高的属性尽量放在一个表里（主表），将字段较长、访问频率较低的属性尽量防在另一个表里（扩展表），并且查询时尽量不要使用 join 查询，避免主表和扩展表耦合在一个数据库实例上。

Q: 为什么要根据长度、访问频率分主表和扩展表？

A: 数据库会以行为单位 load 进自身的进程缓存（磁盘->内存），行的长度越短、访问频率越高，就越能缓存更多的行、提升缓存命中率。


**水平切分**


根据主键划分到不同到库表。


划分方法通常分为范围法（range）和哈希法（hash）。

范围法缺点比较明显，请求量不均，可能某一个库表的访问频率很高，分担压力的效果可能会变差。


哈希法效果较好，但是缺点是扩容麻烦，扩容后的数据查询也会更麻烦。

Q1: 扩容后，如何查找非主键的记录？

A: 暴力方法是遍历所有库，不可取。解法1）建立非主键和主键的映射表，缺点是多一次查询，性能减半；解法2）构造非主键和主键的函数关系，通过非主键可以本地直接得到对应主键，难点是需要构造映射函数；解法3）构造非主键和对应库的函数关系，与解法2类似


Q2: 如何实现平滑扩容（不停机）？

A: 使用双主架构，服务重启后，再改成单主架构，再增加新的双主同步（如何增加同步节点？请参见主从复制章节），保证高可用，最后可以删除冗余数据。[参考](https://www.w3cschool.cn/architectroad/architectroad-database-smooth-expansion.html)。
